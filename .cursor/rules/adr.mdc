---
description: Follow Architecture Decision Records when changing architecture, persistence, or user-facing behavior
alwaysApply: true
---

# Architecture Decision Records (ADRs)

1. **Follow existing ADRs**: When changing architecture, persistence, or user-facing behavior, read the relevant documents in **docs/adr/** and align your implementation with the decisions recorded there.

2. **Consult the index**: Before implementing features that touch those areas, check **docs/adr/README.md** for the list of ADRs and open any that apply.

3. **Adding a new decision**: When making a new architectural or behavioral decision, create a new ADR under docs/adr/ using the template (0000-template.md), use the next number in sequence (e.g. 0002), and update the index in docs/adr/README.md. If the decision affects how agents should work, update this rule or .github/copilot-instructions.md as needed.

4. **Conflicts**: If a requested change would conflict with an accepted ADR, either update the ADR (e.g. supersede it with a new one) or align the implementation with the ADR; do not silently contradict documented decisions.

5. **NuGet packages**: When adding or changing NuGet dependencies, follow [ADR-0013](docs/adr/0013-secure-nuget-packages.md) â€” avoid insecure or obsolete packages.

6. **New visualizers**: Create new visualizer content as `ITextLayerRenderer` layers in TextLayersVisualizer, not as standalone `IVisualizer` implementations. See [ADR-0014](docs/adr/0014-visualizers-as-layers.md).

7. **Layer settings**: TextLayerSettings has common props plus Custom (JSON); layer-specific settings go in *Settings.cs next to the layer; use `GetCustom<TSettings>()` in Draw. See [ADR-0021](docs/adr/0021-textlayer-settings-common-custom.md).

8. **Presets**: TextLayers configurations are stored as Presets in `presets/*.json` (one file per preset). V cycles presets; S modal: R rename, N new preset. See [ADR-0019](docs/adr/0019-preset-textlayers-configuration.md), [ADR-0022](docs/adr/0022-presets-in-own-files.md).

9. **Layer settings editing**: The S settings modal is the canonical UI for editing layer settings (common properties and Custom). When adding layer-editing capabilities, implement them in the S modal, not in HandleKey or other ad-hoc places. See [ADR-0023](docs/adr/0023-settings-modal-layer-editing.md).

10. **Layer settings discovery**: Layer settings are discovered via reflection. New settings: add *Settings.cs with properties; use [SettingRange], [SettingChoices], [Setting] where needed; register in LayerSettingsReflection.s_customSettingsRegistry. See [ADR-0021](docs/adr/0021-textlayer-settings-common-custom.md), [ADR-0025](docs/adr/0025-reflection-based-layer-settings.md).

11. **C# documentation and file organization**: Non-empty XML summaries for classes and interfaces; prefer one file per class. See [ADR-0016](docs/adr/0016-csharp-documentation-and-file-organization.md).

12. **UI text overflow**: Use ScrollingTextViewport for dynamic text (toolbar, status lines) that may exceed width; use ellipsis truncation (TruncateWithEllipsis or equivalent) for static text (titles, labels). See [ADR-0020](docs/adr/0020-ui-text-components-scrolling-and-ellipsis.md).

13. **Layer dependency injection**: Layers that need external services (e.g. INowPlayingProvider) receive them via constructor injection. Snapshot does not carry service-derived data. Layers are registered in the DI container (AddTextLayerRenderers); TextLayersVisualizer receives IEnumerable&lt;ITextLayerRenderer&gt;. See [ADR-0028](docs/adr/0028-layer-dependency-injection.md).

14. **Settings format changes**: Do not add migration logic for old settings. When schema changes cause incompatibility, backup the file with `{name}.{timestamp}.bak` and create new from defaults. See [ADR-0029](docs/adr/0029-no-settings-migration.md).

15. **Performance**: Console writes, polling, and timing must be performant. Follow [ADR-0030](docs/adr/0030-performance-priority.md) when adding console I/O, key polling, or frame-rate logic.
